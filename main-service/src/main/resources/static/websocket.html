<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GiÃ¡m sÃ¡t nÆ°á»›c</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        #turbidityChart {
            width: 600px !important;
            height: 300px !important;
        }
        #status, #wsStatus {
            font-weight: bold;
            font-size: 1.2em;
        }
        .safe { color: green; }
        .unsafe { color: red; }
        .connected { color: blue; }
        .disconnected { color: gray; }
    </style>
</head>
<body>
<h2>ğŸŒŠ Äá»™ Ä‘á»¥c nÆ°á»›c: <span id="turbidity">N/A</span></h2>
<h3>ğŸ•’ Thá»i gian Ä‘o: <span id="timestamp">N/A</span></h3>
<h3>ğŸ” Tráº¡ng thÃ¡i nÆ°á»›c: <span id="status">Äang kiá»ƒm tra...</span></h3>
<h3>ğŸ”Œ Tráº¡ng thÃ¡i WebSocket: <span id="wsStatus" class="disconnected">Máº¥t káº¿t ná»‘i</span></h3>

<canvas id="turbidityChart"></canvas>

<script>
    const TURBIDITY_THRESHOLD = 5.0;
    const wsStatusElement = document.getElementById("wsStatus");

    // Chart.js setup
    const ctx = document.getElementById('turbidityChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Äá»™ Ä‘á»¥c nÆ°á»›c (NTU)',
                data: [],
                borderColor: 'blue',
                borderWidth: 2,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: { display: true, text: 'Thá»i gian' }
                },
                y: {
                    title: { display: true, text: 'NTU' },
                    beginAtZero: true
                }
            }
        }
    });

    // Táº¡o káº¿t ná»‘i SockJS Ä‘áº¿n endpoint Spring websocket (thay Ä‘á»•i URL cho Ä‘Ãºng backend)
    const socket = new SockJS('http://192.168.1.118:9997/ws');

    // Khá»Ÿi táº¡o stomp client tá»« SockJS socket
    const stompClient = Stomp.over(socket);

    // Káº¿t ná»‘i STOMP
    stompClient.connect({}, function(frame) {
        console.log('âœ… STOMP Connected: ' + frame);
        wsStatusElement.innerText = "ÄÃ£ káº¿t ná»‘i";
        wsStatusElement.className = "connected";

        // ÄÄƒng kÃ½ láº¯ng nghe topic dá»¯ liá»‡u Ä‘á»™ Ä‘á»¥c (Ä‘áº£m báº£o backend gá»­i trÃªn topic nÃ y)
        stompClient.subscribe('/topic/turbidity', function(message) {
            const data = JSON.parse(message.body);

            const timestamp = new Date();
            const formattedTime = timestamp.getFullYear() + "-" +
                                  String(timestamp.getMonth() + 1).padStart(2, '0') + "-" +
                                  String(timestamp.getDate()).padStart(2, '0') + " " +
                                  String(timestamp.getHours()).padStart(2, '0') + ":" +
                                  String(timestamp.getMinutes()).padStart(2, '0') + ":" +
                                  String(timestamp.getSeconds()).padStart(2, '0');

            document.getElementById("turbidity").innerText = data.turbidity + " NTU";
            document.getElementById("timestamp").innerText = formattedTime;

            const statusElement = document.getElementById("status");
            if (data.turbidity > TURBIDITY_THRESHOLD) {
                statusElement.innerText = "KhÃ´ng thá»ƒ sá»­ dá»¥ng";
                statusElement.className = "unsafe";
            } else {
                statusElement.innerText = "CÃ³ thá»ƒ sá»­ dá»¥ng";
                statusElement.className = "safe";
            }

            chart.data.labels.push(formattedTime);
            chart.data.datasets[0].data.push(data.turbidity);

            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }

            chart.update();
        });
    }, function(error) {
        console.log('âŒ STOMP Connection error:', error);
        wsStatusElement.innerText = "Máº¥t káº¿t ná»‘i";
        wsStatusElement.className = "disconnected";
    });
</script>
</body>
</html>
